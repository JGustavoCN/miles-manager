@page "/configuracoes"
@using System.Security.Claims
@using Miles.Application.DTOs
@using Miles.Application.Interfaces
@using Miles.Core.Exceptions
@using Miles.WebApp.Auth

@inject IUsuarioService UsuarioService
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">Minha Conta</MudText>
    <MudText Typo="Typo.subtitle1" Class="mb-4">Gerencie seus dados pessoais e segurança.</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Dados Cadastrais" Icon="@Icons.Material.Filled.Person">
            <EditForm Model="@perfilModel" OnValidSubmit="AtualizarPerfil">
                <DataAnnotationsValidator />

                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField Label="Nome Completo" @bind-Value="perfilModel.Nome"
                            For="@(() => perfilModel.Nome)" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="E-mail" Value="@emailExibicao" ReadOnly="true" Variant="Variant.Filled"
                            Margin="Margin.Dense" HelperText="O e-mail não pode ser alterado." />
                    </MudItem>

                    <MudItem xs="12" Class="d-flex justify-end mt-4">
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                            Disabled="@loading">
                            @if (loading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Salvando...</MudText>
                            }
                            else
                            {
                                <MudText>Salvar Alterações</MudText>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudTabPanel>

        <MudTabPanel Text="Segurança" Icon="@Icons.Material.Filled.Lock">
            <EditForm Model="@senhaModel" OnValidSubmit="AlterarSenha">
                <DataAnnotationsValidator />

                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField Label="Senha Atual" @bind-Value="senhaModel.SenhaAtual"
                            For="@(() => senhaModel.SenhaAtual)" InputType="InputType.Password"
                            Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField Label="Nova Senha" @bind-Value="senhaModel.NovaSenha"
                            For="@(() => senhaModel.NovaSenha)" InputType="InputType.Password"
                            Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField Label="Confirmar Nova Senha" @bind-Value="senhaModel.ConfirmacaoSenha"
                            For="@(() => senhaModel.ConfirmacaoSenha)" InputType="InputType.Password"
                            Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" Class="d-flex justify-end mt-4">
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Secondary"
                            Disabled="@loading">
                            @if (loading)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Processando...</MudText>
                            }
                            else
                            {
                                <MudText>Alterar Senha</MudText>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private PerfilInputDTO perfilModel = new();
    private TrocaSenhaInputDTO senhaModel = new();
    private string emailExibicao = string.Empty;
    private int usuarioId;
    private bool loading = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var idClaim = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value
            ?? user.FindFirst("sub")?.Value;

            if (int.TryParse(idClaim, out int id))
            {
                usuarioId = id;
                perfilModel.Nome = user.Identity.Name ?? string.Empty;
                emailExibicao = user.FindFirst(ClaimTypes.Email)?.Value ?? "Não identificado";
            }
        }
    }

    private async Task AtualizarPerfil()
    {
        loading = true;
        try
        {
            UsuarioService.AtualizarPerfil(usuarioId, perfilModel);

            if (AuthStateProvider is CustomAuthenticationStateProvider customAuth)
            {
                await customAuth.NotificarPerfilAtualizadoAsync(perfilModel.Nome);
            }

            Snackbar.Add("Dados atualizados com sucesso!", Severity.Success);
        }
        catch (ValorInvalidoException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
        catch (Exception)
        {
            Snackbar.Add("Erro ao atualizar perfil. Tente novamente.", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    // Removemos 'async Task' pois o serviço é síncrono
    private void AlterarSenha()
    {
        loading = true;
        try
        {
            UsuarioService.AlterarSenha(usuarioId, senhaModel);
            Snackbar.Add("Senha alterada com sucesso!", Severity.Success);

            senhaModel = new TrocaSenhaInputDTO();
        }
        catch (ValorInvalidoException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Erro inesperado ao alterar senha.", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }
}