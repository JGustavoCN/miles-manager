@page "/compras"
@using Miles.Application.DTOs
@using Miles.Application.Interfaces
@using Miles.Core.Exceptions

@inject ITransacaoService TransacaoService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Minhas Compras</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">

    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">Histórico de Compras</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
            OnClick="IrParaNovaTransacao">
            Nova Transação
        </MudButton>
    </div>

    @if (_carregando)
    {
        <div class="d-flex justify-center mt-4">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (!_transacoes.Any())
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            Nenhuma compra registrada. Aproveite para cadastrar sua primeira transação e acumular milhas!
        </MudAlert>
    }
    else
    {
        <MudTable Items="@_transacoes" Hover="true" Striped="true" Class="mt-4">
            <HeaderContent>
                <MudTh>Data</MudTh>
                <MudTh>Descrição</MudTh>
                <MudTh>Cartão</MudTh>
                <MudTh>Valor (R$)</MudTh>
                <MudTh>Pontos (Est.)</MudTh>
                <MudTh Style="text-align:center">Ações</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Data">@context.Data.ToShortDateString()</MudTd>
                <MudTd DataLabel="Descrição">
                    <MudText Typo="Typo.body2">@context.Descricao</MudText>
                    <MudText Typo="Typo.caption">@context.Categoria</MudText>
                </MudTd>
                <MudTd DataLabel="Cartão">@context.NomeCartao</MudTd>
                <MudTd DataLabel="Valor">@context.Valor.ToString("C2")</MudTd>
                <MudTd DataLabel="Pontos">
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">@context.PontosEstimados pts</MudChip>
                </MudTd>
                <MudTd DataLabel="Ações" Style="text-align:center">
                    @* CORREÇÃO: .GetValueOrDefault() para converter int? em int *@
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                        OnClick="@(() => Editar(context.Id.GetValueOrDefault()))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                        OnClick="@(() => Excluir(context))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

</MudContainer>

@code {
    private List<TransacaoInputDTO> _transacoes = new();
    private bool _carregando = true;
    private int _usuarioId = 1;

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        _carregando = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var idClaim = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(idClaim, out int id)) _usuarioId = id;

            _transacoes = await TransacaoService.ObterPorUsuarioAsync(_usuarioId);
        }
        finally
        {
            _carregando = false;
        }
    }

    private void IrParaNovaTransacao()
    {
        NavigationManager.NavigateTo("/transacoes/nova");
    }

    private void Editar(int id)
    {
        NavigationManager.NavigateTo($"/transacoes/editar/{id}");
    }

    private async Task Excluir(TransacaoInputDTO item)
    {
        if (!item.Id.HasValue) return;

        bool? result = await DialogService.ShowMessageBox(
        "Excluir Transação",
        $"Deseja remover a compra '{item.Descricao}'?",
        yesText: "Excluir", cancelText: "Cancelar");

        if (result == true)
        {
            // CORREÇÃO: .Value é seguro aqui pois checamos HasValue antes
            await TransacaoService.RemoverAsync(item.Id.Value);
            Snackbar.Add("Transação removida.", Severity.Success);
            await CarregarDados();
        }
    }
}
