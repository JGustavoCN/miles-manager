@page "/compras"
@using Miles.Core.Entities
@using Miles.Core.Interfaces
@inject ITransacaoRepository TransacaoRepository
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Minhas Compras</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">

    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">Histórico de Compras</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
            OnClick="IrParaNovaTransacao">
            Nova Transação
        </MudButton>
    </div>

    @if (_carregando)
    {
        <div class="d-flex justify-center mt-4">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (!_transacoes.Any())
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            Nenhuma compra registrada. Aproveite para cadastrar sua primeira transação e acumular milhas!
        </MudAlert>
    }
    else
    {
        <MudTable Items="@_transacoes" Hover="true" Striped="true" Class="mt-4">
            <HeaderContent>
                <MudTh>Data</MudTh>
                <MudTh>Descrição</MudTh>
                <MudTh>Cartão</MudTh>
                <MudTh>Valor (R$)</MudTh>
                <MudTh>Pontos (Est.)</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Data">@context.Data.ToShortDateString()</MudTd>
                <MudTd DataLabel="Descrição">
                    <MudText Typo="Typo.body2">@context.Descricao</MudText>
                    <MudText Typo="Typo.caption">@context.Categoria</MudText>
                </MudTd>
                <MudTd DataLabel="Cartão">
                    @if (context.Cartao != null)
                    {
                        @($"{context.Cartao.Nome} ({context.Cartao.Bandeira})")
                    }
                    else
                    {
                        <MudText Color="Color.Error">Cartão excluído</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Valor">@context.Valor.ToString("C2")</MudTd>
                <MudTd DataLabel="Pontos">
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">@context.PontosEstimados pts</MudChip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

</MudContainer>

@code {
    private List<Transacao> _transacoes = new();
    private bool _carregando = true;
    private int _usuarioId = 1; // Fallback para dev

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Simulação de Auth para pegar o usuário correto
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                var idClaim = user.FindFirst(c => c.Type == "sub" || c.Type == System.Security.Claims.ClaimTypes.NameIdentifier);
                if (idClaim != null && int.TryParse(idClaim.Value, out int id)) _usuarioId = id;
            }

            // Busca as transações usando o Repositório
            _transacoes = TransacaoRepository.ObterPorUsuario(_usuarioId);
        }
        finally
        {
            _carregando = false;
        }
    }

    private void IrParaNovaTransacao()
    {
        NavigationManager.NavigateTo("/transacoes/nova");
    }
}