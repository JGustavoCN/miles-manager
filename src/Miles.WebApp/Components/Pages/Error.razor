@page "/Error"
@using System.Diagnostics
@using Microsoft.AspNetCore.Diagnostics
@using MudBlazor

<PageTitle>@_title</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center justify-center" Style="height: 80vh;">
    <MudPaper Elevation="4" Class="pa-8 d-flex flex-column align-center gap-4 rounded-lg">

        @* Ícone Dinâmico (Erro ou 404) *@
        <MudIcon Icon="@_icon" Color="@_iconColor" Size="Size.Large" Style="width: 80px; height: 80px;" />

        <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Dark">
            @_title
        </MudText>

        <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-4 text-secondary">
            @_message
        </MudText>

        @* Exibe o Request ID para suporte *@
        @if (_showRequestId)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="my-2 py-2" NoIcon="false">
                <strong>ID do Suporte:</strong> <code style="color: white">@_requestId</code>
            </MudAlert>
        }

        <div class="d-flex gap-3 mt-4">
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/"
                StartIcon="@Icons.Material.Filled.Home">
                Ir para o Início
            </MudButton>

            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ReloadPage"
                StartIcon="@Icons.Material.Filled.Refresh">
                Tentar Novamente
            </MudButton>
        </div>

    </MudPaper>
</MudContainer>

@code {
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    private string? @_requestId;
    private bool @_showRequestId => !string.IsNullOrEmpty(_requestId);

    // Variáveis de estado da UI
    private string _title = "Ops! Algo deu errado.";
    private string _message = "Ocorreu um erro inesperado. Nossa equipe já foi notificada.";
    private string _icon = Icons.Material.Filled.ErrorOutline;
    private Color _iconColor = Color.Error;

    protected override void OnInitialized()
    {
        // Captura o ID da requisição para rastreabilidade (serilog)
        _requestId = Activity.Current?.Id ?? HttpContext?.TraceIdentifier;

        if (HttpContext != null)
        {
            // Verifica se o erro veio de um redirecionamento de status code (ex: 404)
            var statusCodeFeature = HttpContext.Features.Get<IStatusCodeReExecuteFeature>();

            // Se existe a feature de ReExecute, significa que o usuário tentou acessar uma rota inexistente
            // e o middleware "UseStatusCodePagesWithReExecute" enviou ele para cá.
            if (statusCodeFeature != null)
            {
                ConfigureNotFoundState();
            }
            // Verifica se foi uma exceção real capturada pelo "UseExceptionHandler"
            else
            {
                var exceptionFeature = HttpContext.Features.Get<IExceptionHandlerPathFeature>();
                if (exceptionFeature?.Error is FileNotFoundException)
                {
                    ConfigureNotFoundState();
                }
                // Caso contrário, mantém o estado padrão de Erro 500
            }
        }
    }

    private void ConfigureNotFoundState()
    {
        _title = "Página não encontrada";
        _message = "A página que você está tentando acessar não existe ou foi movida.";
        _icon = Icons.Material.Filled.SearchOff; // Ou Icons.Material.Filled.SentimentVeryDissatisfied
        _iconColor = Color.Warning;
    }

    private void ReloadPage()
    {
        Navigation.Refresh(forceReload: true);
    }
}