@page "/programas"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@inject IProgramaService ProgramaService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@using Miles.Core.Exceptions

<PageTitle>Programas de Fidelidade - Miles Manager</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">
    <MudIcon Icon="@Icons.Material.Filled.CardGiftcard" Class="mr-2" />
    Programas de Fidelidade
</MudText>

<MudText Typo="Typo.body1" Class="mb-4">
    Cadastre e gerencie os programas de milhas/pontos que voc√™ participa (ex: Smiles, Latam Pass, Livelo).
</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudPaper Elevation="3" Class="pa-4">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.Flight" Class="mr-2" />
                    Meus Programas
                </MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                    OnClick="AbrirModalCadastro">
                    Adicionar Programa
                </MudButton>
            </div>

            <MudDivider Class="mb-4" />

            @if (programas == null)
            {
                <div class="d-flex justify-center align-center pa-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (!programas.Any())
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                    <MudText Typo="Typo.body2">üéÅ Nenhum programa cadastrado ainda.</MudText>
                    <MudText Typo="Typo.caption" Class="mt-2">Clique em "Adicionar Programa" para come√ßar.</MudText>
                </MudAlert>
            }
            else
            {
                <MudTable Items="@programas" Hover="true" Striped="true" Dense="true" Elevation="0">
                    <HeaderContent>
                        <MudTh>Nome</MudTh>
                        <MudTh>Empresa/Banco</MudTh>
                        <MudTh Style="text-align:center">A√ß√µes</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Nome">@context.Nome</MudTd>
                        <MudTd DataLabel="Empresa">@context.Banco</MudTd>
                        <MudTd Style="text-align:center">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                                OnClick="@(() => AbrirModalEdicao(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                OnClick="@(() => ConfirmarExclusao(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudPaper Elevation="3" Class="pa-4">
            <MudText Typo="Typo.h6" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                Dicas
            </MudText>
            <MudDivider Class="mb-3" />
            <div class="mt-2 ml-2">
                <MudText Typo="Typo.body2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" /> Nomes
                    devem ser √∫nicos.
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" /> Use
                    nomes f√°ceis de identificar.
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                    Programas com cart√µes vinculados n√£o podem ser exclu√≠dos.
                </MudText>
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

@* --- DIALOG (MODAL) DE CADASTRO/EDI√á√ÉO --- *@
<MudDialog @bind-Visible="dialogVisible" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(isEdicao? Icons.Material.Filled.Edit : Icons.Material.Filled.Add)" Class="mr-2" />
            @(isEdicao ? "Editar Programa" : "Novo Programa")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success">
            <MudTextField T="string" Label="Nome do Programa" @bind-Value="programaModel.Nome" Required="true"
                RequiredError="Nome √© obrigat√≥rio!" Counter="100" MaxLength="100" HelperText="Ex: Smiles, Livelo" />
            <MudTextField T="string" Label="Empresa ou Banco" @bind-Value="programaModel.Banco" Counter="100"
                MaxLength="100" HelperText="Ex: Gol, Bradesco" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="FecharModal">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SalvarPrograma" Disabled="@(!success)">Salvar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<ProgramaFidelidade>? programas;
    private ProgramaInputDTO programaModel = new();
    private bool dialogVisible;
    private bool isEdicao;

    // CORRE√á√ÉO CS8618: Inicializando com null! ou default!
    private MudForm form = null!;

    private bool success;
    private int currentUserId;
    private DialogOptions dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true, CloseButton = true };

    protected override async Task OnInitializedAsync()
    {
        await CarregarUsuario();
        CarregarProgramas();
    }

    private async Task CarregarUsuario()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var idClaim = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(idClaim, out int id))
        {
            currentUserId = id;
        }
    }

    private void CarregarProgramas()
    {
        try
        {
            if (currentUserId > 0)
            {
                programas = ProgramaService.ListarPorUsuario(currentUserId);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar programas: {ex.Message}", Severity.Error);
        }
    }

    // --- A√ß√µes de Modal ---

    private void AbrirModalCadastro()
    {
        isEdicao = false;
        programaModel = new ProgramaInputDTO { UsuarioId = currentUserId };
        dialogVisible = true;
    }

    private void AbrirModalEdicao(ProgramaFidelidade programa)
    {
        isEdicao = true;
        programaModel = new ProgramaInputDTO
        {
            Id = programa.Id,
            Nome = programa.Nome,
            Banco = programa.Banco,
            UsuarioId = programa.UsuarioId
        };
        dialogVisible = true;
    }

    private void FecharModal() => dialogVisible = false;

    private async Task SalvarPrograma()
    {
        await form.Validate();
        if (!form.IsValid) return;

        try
        {
            programaModel.UsuarioId = currentUserId;

            if (isEdicao)
            {
                ProgramaService.Atualizar(programaModel);
                Snackbar.Add("Programa atualizado com sucesso!", Severity.Success);
            }
            else
            {
                ProgramaService.Adicionar(programaModel);
                Snackbar.Add("Programa de fidelidade cadastrado com sucesso", Severity.Success);
            }

            dialogVisible = false;
            CarregarProgramas();
        }
        catch (ValorInvalidoException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro inesperado: {ex.Message}", Severity.Error);
        }
    }

    // --- A√ß√£o de Exclus√£o ---

    private async Task ConfirmarExclusao(ProgramaFidelidade programa)
    {
        // CORRE√á√ÉO CS0246: C√≥digo "placeholder" antigo foi removido.
        // Usamos apenas o MessageBox direto, que √© a abordagem correta.

        bool? result = await DialogService.ShowMessageBox(
        "Excluir Programa",
        $"Tem certeza que deseja excluir '{programa.Nome}'? Esta a√ß√£o n√£o pode ser desfeita.",
        yesText: "Excluir", cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                ProgramaService.Remover(programa.Id);
                Snackbar.Add("Programa removido com sucesso!", Severity.Success);
                CarregarProgramas();
            }
            catch (ValorInvalidoException ex)
            {
                Snackbar.Add(ex.Message, Severity.Warning);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir: {ex.Message}", Severity.Error);
            }
        }
    }
}