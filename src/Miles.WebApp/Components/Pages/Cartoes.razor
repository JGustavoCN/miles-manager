@page "/cartoes"
@using Miles.Application.DTOs
@using Miles.Application.Interfaces
@using Miles.Core.Exceptions
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using Serilog
@attribute [Authorize]

@inject ICartaoService CartaoService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Meus Cartões</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <MudText Typo="Typo.h4">Meus Cartões</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
            OnClick="@(() => AbrirModal())">
            Novo Cartão
        </MudButton>
    </div>

    @if (loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (cartoes == null || !cartoes.Any())
    {
        <MudAlert Severity="Severity.Info">Nenhum cartão cadastrado. Adicione seu primeiro cartão!</MudAlert>
    }
    else
    {
        <MudTable Items="@cartoes" Hover="true" Striped="true" Elevation="2">
            <HeaderContent>
                <MudTh>Nome</MudTh>
                <MudTh>Bandeira</MudTh>
                <MudTh>Limite</MudTh>
                <MudTh>Vencimento</MudTh>
                <MudTh>Pontos/USD</MudTh>
                <MudTh>Ações</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Nome">@context.Nome</MudTd>
                <MudTd DataLabel="Bandeira">
                    <MudChip T="string" Color="Color.Info" Size="Size.Small">@context.Bandeira</MudChip>
                </MudTd>
                <MudTd DataLabel="Limite">@context.Limite.ToString("C")</MudTd>
                <MudTd DataLabel="Vencimento">Dia @context.DiaVencimento</MudTd>
                <MudTd DataLabel="Fator">@context.FatorConversao.ToString("N1")</MudTd>
                <MudTd DataLabel="Ações">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                        OnClick="@(() => AbrirModal(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                        OnClick="@(() => Excluir(context))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    private List<CartaoInputDTO> cartoes = new();
    private bool loading = true;
    private int currentUserId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                var userIdClaim = user.FindFirst(c => c.Type == "sub" || c.Type == System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int id))
                {
                    currentUserId = id;
                    cartoes = await CartaoService.ObterPorUsuarioAsync(currentUserId);
                }
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Erro ao carregar lista de cartões");
            Snackbar.Add($"Erro ao carregar cartões: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task AbrirModal(CartaoInputDTO? cartao = null)
    {
        var parameters = new DialogParameters();
        parameters.Add("UsuarioId", currentUserId);

        string titulo = "Novo Cartão";

        if (cartao != null)
        {
            titulo = "Editar Cartão";
            parameters.Add("CartaoId", cartao.Id);
        }

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        // CORREÇÃO: ShowAsync ao invés de Show
        var dialog = await DialogService.ShowAsync<CartaoForm>(titulo, parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task Excluir(CartaoInputDTO cartao)
    {
        bool? result = await DialogService.ShowMessageBox(
        "Excluir Cartão",
        $"Tem certeza que deseja excluir o cartão '{cartao.Nome}'?",
        yesText: "Sim, Excluir", cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await CartaoService.RemoverAsync(cartao.Id);
                Snackbar.Add("Cartão removido com sucesso", Severity.Success);
                await LoadData();
            }
            catch (DomainException ex)
            {
                Log.Warning(ex, "Tentativa de exclusão bloqueada por regra de domínio");
                Snackbar.Add(ex.Message, Severity.Error);
            }
            catch (Exception ex)
            {
                // CORREÇÃO: Uso da variável ex para log
                Log.Error(ex, "Erro ao tentar excluir cartão {Id}", cartao.Id);
                Snackbar.Add("Erro ao excluir cartão.", Severity.Error);
            }
        }
    }
}